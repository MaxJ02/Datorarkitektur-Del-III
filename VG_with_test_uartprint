 ;********************************************************************************************************
; VG.asm: An assembler program containing serial transmission, where an LED 
;         connected to pin 8 (PORTB0) is pulled via pressing a push button connected 
;         to pin 13 (PORTB5). At startup, the following instructions should be printed in the terminal:
;       
;         Press the button connected to pin 13 to toggle the led connected to pin 8!
;
;          With each press, a message that the push button has been pressed and the new state of the LED 
;          must be printed as below:
;           1 - The button is pressed and the LED lights up: 
;           Button is pressed!
;           Led on!
;           2 - The button is pressed again and the LED turns off:
;           Button is pressed!
;           Led off!
;           3 - The button is pressed once more and the LED lights up again:
;           Button is pressed!
;           Led on!    
;                                          
;*************************************************************************************************************


.EQU LED1 = PORTB0 ; LED ansluten till pin 8. 
.EQU BUTTON1 = PORTB5 ; Tryckknapp ansluten till pin 13.

.EQU RESET_vect        = 0x00 ; Reset-vektor, programmets startpunkt.
.EQU PCINT0_vect       = 0x06 ; Avbrottsvektor för PCI-avbrott på I/O-port B.
.EQU BAUD	           = 9600			; baudrate

;********************************************************************************
; .CSEG: Programminnet - Här lagrar programkoden.
;********************************************************************************
.CSEG

;********************************************************************************
; RESET_vect: Programmets startpunkt. Programhopp sker till subrutinen main
;             för att starta programmet.
;********************************************************************************
.ORG RESET_vect
   RJMP main

;/********************************************************************************
;* PCINT0_vect: Avbrottsvektor för PCI-avbrott på I/O-port B. Vid avbrott sker
;*              programhopp till motsvarande avbrottsrutin ISR_PCINT0.
;********************************************************************************/
.ORG PCINT0_vect 
   RJMP ISR_PCINT0 ; Hoppar till motsvarande avbrottsrutin ISR_PCINT0.

;/********************************************************************************
;* ISR_PCINT0: Avbrottsrutin för PCI-avbrott på I/O-port B, som äger rum vid
;*             nedtryckning och uppsläppning av tryckknappen. Vid nedtryckning 
;*             togglas lysdioden, annars görs ingenting.
;********************************************************************************/
ISR_PCINT0:
   IN R17, PINB             ; Läser insignaler från PINB, sparar en kopia i R17.
   ANDI R17, (1 << BUTTON1) ; Multiplicerar bitvis med 0010 0000.
   BREQ ISR_PCINT0_end      ; Om kvarvarande värde är lika med 0x00 görs ingenting.x
   OUT PINB, R16            ; Annars togglas lysdioden (0000 0001 ligger kvar i R16).
ISR_PCINT0_end:
   RETI                     ; Avslutar avbrottet och återställer systemet.

;**************************************************************
;* subroutine: initUART
;*
;* inputs: r17:r16 - baud rate prescale
;*
;* enables UART transmission with 8 data, 1 parity, no stop bit
;* at input baudrate
;*
;* registers modified: r16
;**************************************************************

initUART:
	STS	UBRR0L,R16			; load baud prescale
	STS	UBRR0H,R17			; to UBRR0

	LDI	R16,(1<<RXEN0)|(1<<TXEN0)	; enable transmitter
	STS	UCSR0B,R16			; and receiver

	RET					; return from subroutine

;**************************************************************
;* subroutine: puts
;*
;* inputs: ZH:ZL - Program Memory address of string to transmit
;*
;* transmits null terminated string via UART
;*
;* registers modified: r16,r17,r30,r31
;**************************************************************

puts:	lpm	r16,Z+				; load character from pmem
	cpi	r16,$00				; check if null
	breq	puts_end			; branch if null

puts_wait:
	lds	r17,UCSR0A			; load UCSR0A into r17
	sbrs	r17,UDRE0			; wait for empty transmit buffer
	rjmp	puts_wait			; repeat loop

	sts	UDR0,r16			; transmit character
	rjmp	puts				; repeat loop

puts_end:
	ret					; return from subroutine


;/********************************************************************************
;* setup: Initierar I/O-portar (lysdioden sätts till utport och den interna 
;*        pullup-resistorn på tryckknappens pin aktiveras) samt aktiverar 
;*        PCI-avbrott på tryckknappens pin. Denna subrutin placeras inline i
;*        i main för att effektivisera programmet (vi slipper programhopp samt
;*        återhopp).
;********************************************************************************/
setup:
   RCALL initUART		   ; call initUART subroutine
   ldi	ZL,LOW(2*myStr)			; load Z pointer with
	ldi	ZH,HIGH(2*myStr)		; myStr address
	rcall	puts				; transmit string
	...
myStr:	.db	"Hello",$00                    
   LDI R16, (1 << LED1)    ; Läser in värdet 0000 0001 i CPU-register R16.
   OUT DDRB, R16           ; Sätter lysdioden till utport.
   LDI R17, (1 << BUTTON1) ; Läser in värdet 0010 0000 i CPU-register R17.
   OUT PORTB, R17          ; Aktiverar den interna pullup-resistorn på tryckknappens pin.
   SEI                     ; Aktiverar avbrott globalt.
   STS PCICR, R16          ; Aktiverar PCI-avbrott på I/O-port B.
   STS PCMSK0, R17         ; Aktiverar PCI-avbrott på tryckknappens pin 13 (PORTB5).

;********************************************************************************
; main: Initierar systemet vid start. Programmet hålls sedan igång så länge
;       matningsspänning tillförs.
;********************************************************************************b
main:
   RCALL setup
main_loop:
   RJMP main_loop
    
